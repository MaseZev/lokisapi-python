# Тесты для LokisApi Python Library

Этот каталог содержит тесты для библиотеки LokisApi Python.

## Запуск тестов

### Установка зависимостей для тестирования

```bash
pip install -e ".[test]"
```

### Запуск всех тестов

```bash
pytest
```

### Запуск тестов с покрытием

```bash
pytest --cov=lokisapi
```

### Запуск конкретных тестовых файлов

```bash
pytest tests/test_client.py
pytest tests/test_utils.py
pytest tests/test_model_cache.py
pytest tests/test_exceptions.py
```

### Запуск тестов с подробным выводом

```bash
pytest -v
```

## Структура тестов

- `test_client.py` - Тесты для основного класса LokisApiClient
- `test_utils.py` - Тесты для утилитарных функций
- `test_model_cache.py` - Тесты для системы кэширования моделей
- `test_exceptions.py` - Тесты для обработки исключений
- `__init__.py` - Инициализация тестового пакета

## Покрытие тестами

Тесты покрывают:

- Инициализацию и конфигурацию клиента
- Генерацию и редактирование изображений
- Чат-комплетации с различными параметрами
- Thinking режим для моделей Gemini 2.5
- Reasoning Effort для моделей GPT-5
- Получение списка моделей и информации о них
- Автоматическое кэширование моделей
- Управление кэшем моделей
- Обработку ошибок (аутентификация, лимиты, ошибки API)
- Все новые типы исключений
- Утилитарные функции для обработки изображений
- Утилитарные функции для работы с моделями
- Валидацию входных данных
- Сетевые ошибки и таймауты

## Мокирование

Тесты используют `unittest.mock` для мокирования HTTP запросов и избежания реальных API вызовов во время тестирования. Это обеспечивает:

- Быстрое выполнение тестов
- Независимость от внешних сервисов
- Надежность и повторяемость тестов
- Отсутствие необходимости в API ключах для тестирования

## Добавление новых тестов

При добавлении новых функций в библиотеку:

1. Добавьте соответствующие тесты в подходящий тестовый файл
2. Тестируйте как успешные, так и ошибочные случаи
3. Используйте мокирование для внешних зависимостей
4. Включайте docstrings с объяснением назначения каждого теста
5. Следуйте существующим соглашениям по именованию (`test_*`)

## Непрерывная интеграция

Эти тесты предназначены для запуска в CI/CD пайплайнах и должны проходить без необходимости доступа к внешним API или учетным данным.

## Особенности тестирования

### Тестирование кэширования моделей
- Проверка автоматического получения моделей из API
- Тестирование кэширования и инвалидации
- Проверка сохранения кэша на диск
- Тестирование резервного использования кэша

### Тестирование обработки ошибок
- Проверка всех новых типов исключений
- Тестирование парсинга ошибок API
- Проверка извлечения метаданных ошибок
- Тестирование retry-after логики

### Тестирование сетевых ошибок
- Мокирование таймаутов
- Тестирование ошибок соединения
- Проверка повторных попыток
- Тестирование недоступности сервиса
